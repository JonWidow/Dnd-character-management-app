<!-- Asset Management Panel for Grid -->
<div id="assetPanel" style="display: none; position: fixed; right: 20px; top: 80px; width: 280px; max-height: 80vh; background: white; border: 2px solid #2a5298; border-radius: 8px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25); z-index: 999; overflow-y: auto; padding: 0;">
    <!-- Header -->
    <div style="padding: 12px 14px; border-bottom: 2px solid #e8ecf1; position: sticky; top: 0; background: white; display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin: 0; font-size: 15px; font-weight: bold; color: #1e3c72;">
            <i class="fas fa-palette mr-2"></i>Assets
        </h3>
        <button id="closeAssetPanel" style="background: none; border: none; font-size: 18px; cursor: pointer; color: #666; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <!-- Category Filter -->
    <div style="padding: 12px 14px; border-bottom: 1px solid #f0f0f0;">
        <div style="font-size: 12px; font-weight: 600; color: #666; margin-bottom: 8px;">CATEGORY</div>
        <select id="assetCategoryFilter" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
            <option value="">All Categories</option>
        </select>
    </div>
    
    <!-- Assets List -->
    <div id="assetsList" style="padding: 8px 14px;">
        <!-- Assets will be loaded here -->
    </div>
</div>

<!-- Asset Context Menu -->
<div id="assetContextMenu" style="display: none; position: fixed; background: white; border: 2px solid #2a5298; border-radius: 8px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25); z-index: 1001; min-width: 160px; overflow: hidden;">
    <div class="context-item" id="rotateAsset" style="padding: 10px 14px; cursor: pointer; border-bottom: 1px solid #f0f0f0; color: #333; font-weight: 500; transition: all 0.15s ease;">
        <i class="fas fa-redo mr-2"></i>Rotate
    </div>
    <div class="context-item" id="duplicateAsset" style="padding: 10px 14px; cursor: pointer; border-bottom: 1px solid #f0f0f0; color: #333; font-weight: 500; transition: all 0.15s ease;">
        <i class="fas fa-copy mr-2"></i>Duplicate
    </div>
    <div class="context-item danger" id="deleteAsset" style="padding: 10px 14px; cursor: pointer; color: #e74c3c; font-weight: 500; transition: all 0.15s ease;">
        <i class="fas fa-trash mr-2"></i>Delete
    </div>
</div>

<script>
    // Global AssetLoader instance
    let assetLoader = null;
    let selectedAssetPath = null;
    
    // Asset panel visibility toggle
    const assetPanelBtn = document.getElementById('toggleAssetPanel');
    const assetPanel = document.getElementById('assetPanel');
    const closeAssetPanelBtn = document.getElementById('closeAssetPanel');
    
    if (assetPanelBtn && assetPanel && closeAssetPanelBtn) {
        assetPanelBtn.addEventListener('click', () => {
            assetPanel.style.display = assetPanel.style.display === 'none' ? 'block' : 'none';
            if (assetPanel.style.display === 'block' && !assetLoader) {
                initAssetLoader();
            }
        });
        
        closeAssetPanelBtn.addEventListener('click', () => {
            assetPanel.style.display = 'none';
        });
    }
    
    // Initialize AssetLoader when needed
    async function initAssetLoader() {
        try {
            // Fetch available assets
            const assetsResponse = await fetch('/api/assets/files');
            const assets = await assetsResponse.json();
            
            // Fetch categories
            const categoriesResponse = await fetch('/api/assets/files/categories');
            const categories = await categoriesResponse.json();
            
            // Display assets in palette
            displayAssetPalette(assets, categories);
        } catch (error) {
            console.error('Error initializing asset loader:', error);
            document.getElementById('assetsList').innerHTML = '<p style="color: #e74c3c; padding: 10px;">Error loading assets</p>';
        }
    }
    
    function displayAssetPalette(assets, categories) {
        const assetsList = document.getElementById('assetsList');
        const categoryFilter = document.getElementById('assetCategoryFilter');
        
        assetsList.innerHTML = '';
        categoryFilter.innerHTML = '<option value="">All Categories</option>';
        
        // Add category options
        Object.entries(categories).forEach(([key, desc]) => {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = key.charAt(0).toUpperCase() + key.slice(1);
            categoryFilter.appendChild(option);
        });
        
        // Display assets by category
        const displayByCategory = (selectedCat = '') => {
            assetsList.innerHTML = '';
            
            Object.entries(assets).forEach(([category, assetList]) => {
                if (selectedCat && category !== selectedCat) return;
                
                if (assetList.length === 0) {
                    assetsList.innerHTML += `<p style="color: #999; padding: 10px; font-size: 12px;">No assets in ${category}</p>`;
                    return;
                }
                
                if (!selectedCat) {
                    const categoryLabel = document.createElement('div');
                    categoryLabel.style.cssText = 'padding: 8px 14px 4px; font-weight: 600; font-size: 11px; color: #999; text-transform: uppercase; border-bottom: 1px solid #f0f0f0; margin: 8px 0 4px 0;';
                    categoryLabel.textContent = category;
                    assetsList.appendChild(categoryLabel);
                }
                
                assetList.forEach(asset => {
                    const assetEl = document.createElement('div');
                    assetEl.style.cssText = `
                        padding: 10px;
                        margin: 4px 0;
                        background: #f9f9f9;
                        border: 1px solid #e0e0e0;
                        border-radius: 6px;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        display: flex;
                        gap: 8px;
                        align-items: center;
                    `;
                    
                    // Asset preview image
                    const preview = document.createElement('img');
                    preview.src = asset.path;
                    preview.style.cssText = 'width: 40px; height: 40px; object-fit: contain; background: white; border: 1px solid #ddd; border-radius: 4px;';
                    preview.onerror = () => {
                        preview.style.background = '#e8ecf1';
                        preview.style.display = 'none';
                    };
                    
                    // Asset name
                    const label = document.createElement('div');
                    label.style.cssText = 'flex: 1;';
                    label.innerHTML = `<div style="font-weight: 600; font-size: 12px; color: #333;">${asset.name}</div>`;
                    
                    assetEl.appendChild(preview);
                    assetEl.appendChild(label);
                    
                    assetEl.addEventListener('mouseenter', () => {
                        assetEl.style.background = '#f0f4ff';
                        assetEl.style.borderColor = '#2a5298';
                    });
                    
                    assetEl.addEventListener('mouseleave', () => {
                        assetEl.style.background = '#f9f9f9';
                        assetEl.style.borderColor = '#e0e0e0';
                    });
                    
                    assetEl.addEventListener('click', () => {
                        selectedAssetPath = asset.path;
                        window.selectedAsset = asset;
                        assetPanel.style.display = 'none';
                        console.log('Selected asset:', asset);
                    });
                    
                    assetsList.appendChild(assetEl);
                });
            });
        };
        
        // Initial display
        displayByCategory();
        
        // Category filter change
        categoryFilter.addEventListener('change', (e) => {
            displayByCategory(e.target.value);
        });
    }
    
    // Context menu handlers
    const contextMenu = document.getElementById('assetContextMenu');
    const rotateBtn = document.getElementById('rotateAsset');
    const duplicateBtn = document.getElementById('duplicateAsset');
    const deleteBtn = document.getElementById('deleteAsset');
    
    rotateBtn?.addEventListener('click', () => {
        if (contextMenu.currentAsset) {
            contextMenu.currentAsset.rotate((contextMenu.currentAsset.rotation() || 0) + 45);
            assetLayer?.draw?.();
            contextMenu.style.display = 'none';
        }
    });
    
    duplicateBtn?.addEventListener('click', () => {
        if (contextMenu.currentAsset) {
            const asset = contextMenu.currentAsset;
            // Logic to duplicate asset
            contextMenu.style.display = 'none';
        }
    });
    
    deleteBtn?.addEventListener('click', () => {
        if (contextMenu.currentAsset) {
            contextMenu.currentAsset.destroy();
            assetLayer?.draw?.();
            contextMenu.style.display = 'none';
        }
    });
    
    // Close context menu on click elsewhere
    document.addEventListener('click', (e) => {
        if (!e.target.closest('#assetContextMenu')) {
            contextMenu.style.display = 'none';
        }
    });
</script>
