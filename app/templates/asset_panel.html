<!-- Asset Management Panel for Grid -->
<div id="assetPanel" style="display: none; position: fixed; right: 20px; top: 80px; width: 280px; max-height: 80vh; background: white; border: 2px solid #2a5298; border-radius: 8px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25); z-index: 999; overflow-y: auto; padding: 0;">
    <!-- Header -->
    <div style="padding: 12px 14px; border-bottom: 2px solid #e8ecf1; position: sticky; top: 0; background: white; display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin: 0; font-size: 15px; font-weight: bold; color: #1e3c72;">
            <i class="fas fa-palette mr-2"></i>Assets
        </h3>
        <button id="closeAssetPanel" style="background: none; border: none; font-size: 18px; cursor: pointer; color: #666; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <!-- Category Filter -->
    <div style="padding: 12px 14px; border-bottom: 1px solid #f0f0f0;">
        <button id="testAssetPlacement" style="width: 100%; background: #ff9800; padding: 8px; border: none; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; margin-bottom: 8px;">
            Test: Place Grass
        </button>
        <div style="font-size: 12px; font-weight: 600; color: #666; margin-bottom: 8px;">CATEGORY</div>
        <select id="assetCategoryFilter" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
            <option value="">All Categories</option>
        </select>
    </div>
    
    <!-- Assets List -->
    <div id="assetsList" style="padding: 8px 14px;">
        <!-- Assets will be loaded here -->
    </div>
</div>

<!-- Asset Context Menu -->
<div id="assetContextMenu" style="display: none; position: fixed; background: white; border: 2px solid #2a5298; border-radius: 8px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25); z-index: 1001; min-width: 160px; overflow: hidden;">
    <div class="context-item" id="rotateAsset" style="padding: 10px 14px; cursor: pointer; border-bottom: 1px solid #f0f0f0; color: #333; font-weight: 500; transition: all 0.15s ease;">
        <i class="fas fa-redo mr-2"></i>Rotate
    </div>
    <div class="context-item" id="duplicateAsset" style="padding: 10px 14px; cursor: pointer; border-bottom: 1px solid #f0f0f0; color: #333; font-weight: 500; transition: all 0.15s ease;">
        <i class="fas fa-copy mr-2"></i>Duplicate
    </div>
    <div class="context-item danger" id="deleteAsset" style="padding: 10px 14px; cursor: pointer; color: #e74c3c; font-weight: 500; transition: all 0.15s ease;">
        <i class="fas fa-trash mr-2"></i>Delete
    </div>
</div>

<script>
    console.log('[AssetPanel] Asset panel script loaded');
    
    // Global state to track dragging
    window.draggedAssetData = null;
    
    // Global AssetLoader instance
    let assetLoader = null;
    let selectedAssetPath = null;
    
    // Asset panel visibility toggle
    const assetPanelBtn = document.getElementById('toggleAssetPanel');
    const assetPanel = document.getElementById('assetPanel');
    const closeAssetPanelBtn = document.getElementById('closeAssetPanel');
    const testBtn = document.getElementById('testAssetPlacement');
    
    console.log('[AssetPanel] Elements found:', {assetPanelBtn, assetPanel, closeAssetPanelBtn, testBtn});
    
    // Test button handler
    if (testBtn) {
        testBtn.addEventListener('click', async () => {
            console.log('[AssetPanel] Test button clicked');
            if (window.assetPlacementHandler && window.assetLoader) {
                console.log('[AssetPanel] Handlers ready, calling placeAsset');
                try {
                    await window.assetPlacementHandler.placeAsset(200, 200, '/static/assets/terrain/grass.svg');
                    console.log('[AssetPanel] placeAsset completed');
                } catch (error) {
                    console.error('[AssetPanel] placeAsset error:', error);
                }
            } else {
                console.error('[AssetPanel] Handlers not ready:', {
                    handler: !!window.assetPlacementHandler,
                    loader: !!window.assetLoader
                });
            }
        });
    }
    
    if (assetPanelBtn && assetPanel && closeAssetPanelBtn) {
        assetPanelBtn.addEventListener('click', () => {
            console.log('[AssetPanel] Toggle button clicked');
            assetPanel.style.display = assetPanel.style.display === 'none' ? 'block' : 'none';
            if (assetPanel.style.display === 'block') {
                console.log('[AssetPanel] Panel opened, loading assets');
                initAssetLoader();
            }
        });
        
        closeAssetPanelBtn.addEventListener('click', () => {
            console.log('[AssetPanel] Close button clicked');
            assetPanel.style.display = 'none';
        });
    }
    
    // Initialize AssetLoader when needed
    async function initAssetLoader() {
        try {
            console.log('[AssetPanel] Fetching assets from API');
            // Fetch available assets
            const assetsResponse = await fetch('/api/assets/files');
            const assets = await assetsResponse.json();
            console.log('[AssetPanel] Assets received:', assets);
            
            // Fetch categories
            const categoriesResponse = await fetch('/api/assets/files/categories');
            const categories = await categoriesResponse.json();
            console.log('[AssetPanel] Categories received:', categories);
            
            // Display assets in palette
            displayAssetPalette(assets, categories);
        } catch (error) {
            console.error('[AssetPanel] Error initializing asset loader:', error);
            document.getElementById('assetsList').innerHTML = '<p style="color: #e74c3c; padding: 10px;">Error loading assets</p>';
        }
    }
    
    function displayAssetPalette(assets, categories) {
        const assetsList = document.getElementById('assetsList');
        const categoryFilter = document.getElementById('assetCategoryFilter');
        
        assetsList.innerHTML = '';
        categoryFilter.innerHTML = '<option value="">All Categories</option>';
        
        // Add category options
        Object.entries(categories).forEach(([key, desc]) => {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = key.charAt(0).toUpperCase() + key.slice(1);
            categoryFilter.appendChild(option);
        });
        
        // Display assets by category
        const displayByCategory = (selectedCat = '') => {
            assetsList.innerHTML = '';
            
            Object.entries(assets).forEach(([category, assetList]) => {
                if (selectedCat && category !== selectedCat) return;
                
                if (assetList.length === 0) {
                    assetsList.innerHTML += `<p style="color: #999; padding: 10px; font-size: 12px;">No assets in ${category}</p>`;
                    return;
                }
                
                if (!selectedCat) {
                    const categoryLabel = document.createElement('div');
                    categoryLabel.style.cssText = 'padding: 8px 14px 4px; font-weight: 600; font-size: 11px; color: #999; text-transform: uppercase; border-bottom: 1px solid #f0f0f0; margin: 8px 0 4px 0;';
                    categoryLabel.textContent = category;
                    assetsList.appendChild(categoryLabel);
                }
                
                assetList.forEach(asset => {
                    console.log('[AssetPanel] Creating asset element for:', asset.name);
                    
                    const assetEl = document.createElement('div');
                    assetEl.className = 'asset-item';
                    assetEl.setAttribute('data-asset-path', asset.path);
                    assetEl.setAttribute('data-asset-name', asset.name);
                    assetEl.style.cssText = `
                        padding: 10px;
                        margin: 4px 0;
                        background: #f9f9f9;
                        border: 1px solid #e0e0e0;
                        border-radius: 6px;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        display: flex;
                        gap: 8px;
                        align-items: center;
                    `;
                    
                    // Asset preview image
                    const preview = document.createElement('img');
                    preview.src = asset.path;
                    preview.style.cssText = 'width: 40px; height: 40px; object-fit: contain; background: white; border: 1px solid #ddd; border-radius: 4px;';
                    preview.onerror = () => {
                        preview.style.background = '#e8ecf1';
                        preview.style.display = 'none';
                    };
                    
                    // Asset name
                    const label = document.createElement('div');
                    label.style.cssText = 'flex: 1;';
                    label.innerHTML = `<div style="font-weight: 600; font-size: 12px; color: #333;">${asset.name}</div>`;
                    
                    assetEl.appendChild(preview);
                    assetEl.appendChild(label);
                    
                    assetEl.addEventListener('mouseenter', () => {
                        assetEl.style.background = '#f0f4ff';
                        assetEl.style.borderColor = '#2a5298';
                    });
                    
                    assetEl.addEventListener('mouseleave', () => {
                        assetEl.style.background = '#f9f9f9';
                        assetEl.style.borderColor = '#e0e0e0';
                    });
                    
                    // Drag support with detailed logging
                    assetEl.draggable = true;
                    assetEl.addEventListener('dragstart', (e) => {
                        console.log('[AssetPanel] Drag started for:', asset.name);
                        e.dataTransfer.effectAllowed = 'copy';
                        // Store in global variable for cross-window transfer
                        window.draggedAssetData = asset;
                        console.log('[AssetPanel] Stored asset in window.draggedAssetData');
                        // Also try setting dataTransfer data as fallback
                        try {
                            e.dataTransfer.setData('text/plain', JSON.stringify(asset));
                            console.log('[AssetPanel] Also set text/plain data');
                        } catch (err) {
                            console.error('[AssetPanel] Could not set dataTransfer data:', err);
                        }
                    });
                    
                    assetEl.addEventListener('dragend', (e) => {
                        console.log('[AssetPanel] Drag ended for:', asset.name);
                        e.dataTransfer.dropEffect = 'copy';
                    });
                    
                    console.log('[AssetPanel] About to append element for:', asset.name, 'to container with id:', assetsList.id);
                    assetsList.appendChild(assetEl);
                    console.log('[AssetPanel] Asset element added to list:', asset.name);
                });
            });
        };
        
        // Use event delegation for click handling - more reliable than individual handlers
        // Add debounce to prevent multiple clicks
        let lastClickTime = 0;
        const CLICK_DEBOUNCE_MS = 500;
        
        assetsList.addEventListener('click', async (e) => {
            const assetEl = e.target.closest('.asset-item');
            if (!assetEl) return;
            
            // Debounce clicks
            const now = Date.now();
            if (now - lastClickTime < CLICK_DEBOUNCE_MS) {
                console.log('[AssetPanel] Click debounced - too soon');
                return;
            }
            lastClickTime = now;
            
            const assetPath = assetEl.getAttribute('data-asset-path');
            const assetName = assetEl.getAttribute('data-asset-name');
            
            console.log('[AssetPanel] Asset element clicked via delegation:', assetName, assetPath);
            e.stopPropagation();
            
            try {
                // Close the panel
                assetPanel.style.display = 'none';
                
                // Try to place asset directly
                if (window.assetPlacementHandler && window.assetLoader) {
                    console.log('[AssetPanel] Placing asset directly via handler');
                    // Place at center of grid (snap to grid)
                    const CELL_SIZE = 50;
                    const centerX = Math.round(500 / CELL_SIZE) * CELL_SIZE;
                    const centerY = Math.round(500 / CELL_SIZE) * CELL_SIZE;
                    await window.assetPlacementHandler.placeAsset(centerX, centerY, assetPath);
                    console.log('[AssetPanel] Asset placement completed');
                } else if (window.gridModule && window.gridModule.setAssetPlacementMode) {
                    console.log('[AssetPanel] Enabling placement mode');
                    window.gridModule.setAssetPlacementMode(assetPath);
                } else {
                    console.error('[AssetPanel] No handlers available:', {
                        assetPlacementHandler: !!window.assetPlacementHandler,
                        assetLoader: !!window.assetLoader,
                        gridModule: !!window.gridModule
                    });
                }
            } catch (error) {
                console.error('[AssetPanel] Error during asset placement:', error);
            }
        });
        
        // Initial display
        displayByCategory();
        
        // Category filter change
        categoryFilter.addEventListener('change', (e) => {
            displayByCategory(e.target.value);
        });
    }
    
    // Context menu handlers
    const contextMenu = document.getElementById('assetContextMenu');
    const rotateBtn = document.getElementById('rotateAsset');
    const duplicateBtn = document.getElementById('duplicateAsset');
    const deleteBtn = document.getElementById('deleteAsset');
    
    rotateBtn?.addEventListener('click', () => {
        if (contextMenu.currentAsset) {
            contextMenu.currentAsset.rotate((contextMenu.currentAsset.rotation() || 0) + 45);
            assetLayer?.draw?.();
            contextMenu.style.display = 'none';
        }
    });
    
    duplicateBtn?.addEventListener('click', () => {
        if (contextMenu.currentAsset) {
            const asset = contextMenu.currentAsset;
            // Logic to duplicate asset
            contextMenu.style.display = 'none';
        }
    });
    
    deleteBtn?.addEventListener('click', () => {
        if (contextMenu.currentAsset) {
            contextMenu.currentAsset.destroy();
            assetLayer?.draw?.();
            contextMenu.style.display = 'none';
        }
    });
    
    // Close context menu on click elsewhere
    document.addEventListener('click', (e) => {
        if (!e.target.closest('#assetContextMenu')) {
            contextMenu.style.display = 'none';
        }
    });
</script>
