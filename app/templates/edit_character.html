{% extends "base.html" %}
{% block title %}Edit {{ character.name }}{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto p-6">
  <h1 class="text-2xl font-bold mb-4">Edit {{ character.name }}</h1>

  <form method="POST" class="space-y-4">
    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-medium">Name</label>
        <input name="name" value="{{ character.name }}" class="w-full border rounded p-2">
      </div>
      <div>
        <label class="block text-sm font-medium">Race</label>
        <input name="race" value="{{ character.race }}" class="w-full border rounded p-2">
      </div>
      <div>
        <label class="block text-sm font-medium">Character Class</label>
        <input name="char_class" value="{{ character.char_class_name }}" class="w-full border rounded p-2" disabled>
        <p class="text-xs text-gray-500">
          Class editing disabled here to avoid mismatch; change on a separate flow if needed.
        </p>
      </div>
      <div>
        <label class="block text-sm font-medium">Level</label>
        <input type="number" min="1" name="level" value="{{ character.level }}" class="w-full border rounded p-2">
      </div>
    </div>

    <!-- Ability Scores -->
    <div>
      <h2 class="font-semibold text-gray-700">Ability Scores</h2>

      {% set abilities = character.abilities %}

      <div class="grid grid-cols-3 sm:grid-cols-6 gap-2">
        {% for key, label in {
          'str_sc': 'STR', 'dex_sc': 'DEX', 'con_sc': 'CON',
          'int_sc': 'INT', 'wis_sc': 'WIS', 'cha_sc': 'CHA'
        }.items() %}
          <div>
            <label class="block text-xs font-medium">{{ label }}</label>
            <input type="number" name="{{ key }}" value="{{ abilities[key] }}" class="w-full border rounded p-2">
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- Known Spells (Collapsible) -->
    <div class="border rounded-md">
      <button type="button" id="toggleSpells"
              class="w-full flex justify-between items-center px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-t-md">
        <span class="font-semibold text-gray-700">Known Spells</span>
        <svg id="arrowIcon" xmlns="http://www.w3.org/2000/svg" fill="none"
             viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"
             class="w-4 h-4 transform transition-transform duration-200">
          <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
        </svg>
      </button>

      <div id="spellsSection" class="hidden p-4">
        <p class="text-xs text-gray-500 mb-4">
          Hold Ctrl/Cmd to multi-select. Spells are organized by level.
        </p>
        
        {% set spells_by_level = {} %}
        {% for sp in available_spells %}
          {% if spells_by_level.update({sp.level: spells_by_level.get(sp.level, []) + [sp]}) %}{% endif %}
        {% endfor %}

        <!-- Tabs -->
        <div class="flex border-b mb-4 flex-wrap gap-2">
          {% for level in range(0, 10) %}
            {% if spells_by_level.get(level) %}
              <button type="button" class="spell-tab px-3 py-2 font-medium text-sm {% if level == 0 %}bg-blue-600 text-white{% else %}bg-gray-200 hover:bg-gray-300{% endif %}" data-level="{{ level }}">
                {% if level == 0 %}Cantrips{% else %}Level {{ level }}{% endif %}
              </button>
            {% endif %}
          {% endfor %}
        </div>

        <!-- Tab Content -->
        {% for level in range(0, 10) %}
          {% if spells_by_level.get(level) %}
            <div id="spells-level-{{ level }}" class="spell-content {% if level != 0 %}hidden{% endif %}">
              <select name="known_spells" multiple size="8" class="w-full border rounded p-2">
                {% set current_ids = character.spells | map(attribute='id') | list %}
                {% for sp in spells_by_level[level] | sort(attribute='name') %}
                  <option value="{{ sp.id }}" {% if sp.id in current_ids %}selected{% endif %}>
                    {{ sp.name }}
                  </option>
                {% endfor %}
              </select>
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </div>

    <div class="flex justify-end space-x-2 mt-4">
      <a href="{{ url_for('character_details', char_id=character.id) }}"
         class="px-3 py-2 bg-gray-200 rounded hover:bg-gray-300">
        Cancel
      </a>
      <button class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Save</button>
    </div>
  </form>
</div>

<script>
  const toggleSpells = document.getElementById('toggleSpells');
  const spellsSection = document.getElementById('spellsSection');
  const arrowIcon = document.getElementById('arrowIcon');

  toggleSpells?.addEventListener('click', () => {
    spellsSection.classList.toggle('hidden');
    arrowIcon.classList.toggle('rotate-180');
  });

  // Spell tabs
  const spellTabs = document.querySelectorAll('.spell-tab');
  spellTabs.forEach(tab => {
    tab.addEventListener('click', (e) => {
      e.preventDefault();
      const level = tab.dataset.level;

      // Hide all contents
      document.querySelectorAll('.spell-content').forEach(content => {
        content.classList.add('hidden');
      });

      // Remove active style from all tabs
      spellTabs.forEach(t => {
        t.classList.remove('bg-blue-600', 'text-white');
        t.classList.add('bg-gray-200');
      });

      // Show selected content and style tab
      document.getElementById(`spells-level-${level}`).classList.remove('hidden');
      tab.classList.remove('bg-gray-200');
      tab.classList.add('bg-blue-600', 'text-white');
    });
  });
</script>
{% endblock %}
