{% extends "base.html" %}
{% block title %}{{ character_class.name }} | D&D Character Class{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
  <!-- Header -->
  <div class="bg-gradient-to-r from-blue-900 to-blue-800 text-white p-8 rounded-lg mb-8">
    <div class="flex justify-between items-start">
      <div>
        <h1 class="text-5xl font-bold mb-2">{{ character_class.name }}</h1>
        <p class="text-blue-100">Player's Handbook Class</p>
      </div>
      <a href="{{ url_for('characters') }}" class="text-blue-100 hover:text-white">← Back</a>
    </div>
  </div>

  <!-- Class Stats Cards -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
    <!-- Hit Die -->
    <div class="rounded-lg shadow p-6" style="background-color: #fafbfc;">
      <div class="text-gray-600 text-sm font-semibold mb-1">HIT DIE</div>
      <div class="text-4xl font-bold text-blue-600">d{{ character_class.hit_die }}</div>
      <p class="text-gray-600 text-sm mt-2">Determines HP per level</p>
    </div>

    <!-- Spellcasting Ability -->
    <div class="rounded-lg shadow p-6" style="background-color: #fafbfc;">
      <div class="text-gray-600 text-sm font-semibold mb-1">SPELLCASTING</div>
      {% if character_class.spellcasting_ability %}
        <div class="text-4xl font-bold text-purple-600">{{ character_class.spellcasting_ability }}</div>
        <p class="text-gray-600 text-sm mt-2">Primary ability for spells</p>
      {% else %}
        <div class="text-2xl font-bold text-gray-400">—</div>
        <p class="text-gray-600 text-sm mt-2">Non-spellcasting class</p>
      {% endif %}
    </div>

    <!-- Prepares Spells -->
    <div class="rounded-lg shadow p-6" style="background-color: #fafbfc;">
      <div class="text-gray-600 text-sm font-semibold mb-1">SPELL PREPARATION</div>
      <div class="text-3xl font-bold {% if character_class.prepares_spells %}text-green-600{% else %}text-gray-400{% endif %}">
        {{ "✓" if character_class.prepares_spells else "✗" }}
      </div>
      <p class="text-gray-600 text-sm mt-2">{{ "Prepares spells daily" if character_class.prepares_spells else "Knows spells permanently" }}</p>
    </div>
  </div>

  <!-- Description -->
  {% if character_class.description %}
    <div class="rounded-lg shadow p-6 mb-8" style="background-color: #fafbfc;">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Overview</h2>
      <div class="prose prose-sm max-w-none text-gray-700">
        {{ character_class.description | safe }}
      </div>
    </div>
  {% endif %}

  <!-- Proficiencies -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
    {% if character_class.skill_proficiencies or character_class.skill_choice_count > 0 %}
    <div class="rounded-lg shadow p-6" style="background-color: #fafbfc;">
      <h3 class="text-lg font-bold text-gray-800 mb-3">Skill Proficiencies</h3>
      <div class="space-y-3">
        {% if character_class.skill_choice_count > 0 and character_class.skill_proficiencies %}
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3">
            <p class="text-sm font-semibold text-blue-900 mb-2">
              Choose {{ character_class.skill_choice_count }} from:
            </p>
            <div class="flex flex-wrap gap-2">
              {% for skill in character_class.skill_proficiencies %}
                <span class="inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm whitespace-nowrap">{{ skill|trim }}</span>
              {% endfor %}
            </div>
          </div>
        {% elif character_class.skill_proficiencies %}
          <div class="flex flex-wrap gap-2">
            {% for skill in character_class.skill_proficiencies %}
              <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm">{{ skill }}</span>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>
    {% endif %}

    {% if character_class.saving_throw_proficiencies %}
    <div class="rounded-lg shadow p-6" style="background-color: #fafbfc;">
      <h3 class="text-lg font-bold text-gray-800 mb-3">Saving Throw Proficiencies</h3>
      <div class="flex flex-wrap gap-2">
        {% set save_list = character_class.saving_throw_proficiencies | ensure_list %}
        {% for save in save_list %}
          <span class="inline-block bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm whitespace-nowrap">{{ save|trim }}</span>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    {% if character_class.armor_proficiencies %}
    <div class="rounded-lg shadow p-6" style="background-color: #fafbfc;">
      <h3 class="text-lg font-bold text-gray-800 mb-3">Armor Proficiencies</h3>
      <div class="flex flex-wrap gap-2">
        {% set armor_list = character_class.armor_proficiencies | ensure_list %}
        {% for armor in armor_list %}
          <span class="inline-block bg-amber-100 text-amber-800 px-3 py-1 rounded-full text-sm font-medium whitespace-nowrap">{{ armor|trim }}</span>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    {% if character_class.weapon_proficiencies %}
    <div class="rounded-lg shadow p-6" style="background-color: #fafbfc;">
      <h3 class="text-lg font-bold text-gray-800 mb-3">Weapon Proficiencies</h3>
      <div class="flex flex-wrap gap-2">
        {% set weapon_list = character_class.weapon_proficiencies | ensure_list %}
        {% for weapon in weapon_list %}
          <span class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm whitespace-nowrap">{{ weapon|trim }}</span>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    {% if character_class.tool_proficiencies %}
    <div class="rounded-lg shadow p-6" style="background-color: #fafbfc;">
      <h3 class="text-lg font-bold text-gray-800 mb-3">Tool Proficiencies</h3>
      <div class="flex flex-wrap gap-2">
        {% set tool_list = character_class.tool_proficiencies | ensure_list %}
        {% for tool in tool_list %}
          <span class="inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm whitespace-nowrap">{{ tool|trim }}</span>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Class Features -->
  {% if character_class.features %}
    <div class="mb-8">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">Class Features</h2>

      {% set grouped = {} %}
      {% for feature in character_class.features.order_by('level', 'name') %}
        {% set level = feature.level %}
        {% if not grouped.get(level) %}
          {% set _ = grouped.update({level: []}) %}
        {% endif %}
        {% set _ = grouped[level].append(feature) %}
      {% endfor %}

      <div class="space-y-6">
        {% for level, features in grouped.items() %}
          <div class="bg-gray-50 rounded-lg overflow-hidden">
            <!-- Level Header -->
            <div class="bg-blue-100 border-l-4 border-blue-600 px-6 py-3">
              <h3 class="text-lg font-bold text-blue-900">Level {{ level }}</h3>
            </div>
            
            <!-- Features for this level -->
            <div class="divide-y">
              {% for feature in features %}
                <details class="group p-6 hover:bg-blue-50 transition cursor-pointer">
                  <summary class="flex items-start justify-between font-semibold text-gray-800 select-none">
                    <span>{{ feature.name }}</span>
                    <span class="text-gray-400 group-open:rotate-180 transition">▼</span>
                  </summary>
                  
                  <div class="mt-4 pt-4 border-t border-gray-200 space-y-3">
                    {% if feature.description %}
                      <div class="text-gray-700">
                        {{ feature.description | safe }}
                      </div>
                    {% endif %}
                    
                    {% if feature.uses %}
                      <div class="bg-amber-50 border border-amber-200 rounded p-3">
                        <p class="text-sm"><strong>Uses:</strong> {{ feature.uses }}</p>
                      </div>
                    {% endif %}
                    
                    {% if feature.scaling %}
                      <div class="bg-purple-50 border border-purple-200 rounded p-3">
                        <p class="text-sm font-semibold text-purple-900 mb-2">At Higher Levels:</p>
                        <pre class="text-xs text-purple-800 overflow-auto">{{ feature.scaling | tojson(indent=2) }}</pre>
                      </div>
                    {% endif %}
                  </div>
                </details>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  <!-- Subclasses Section -->
  {% set subclasses = character_class.subclasses.all() %}
  {% if subclasses %}
    <div class="rounded-lg shadow p-6" style="background-color: #fafbfc;">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">Subclasses ({{ subclasses|length }})</h2>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        {% for subclass in subclasses|sort(attribute='name') %}
          <a href="{{ url_for('subclass_details', subclass_id=subclass.id) }}" class="block p-4 border border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition">
            <h3 class="font-semibold text-gray-800 hover:text-blue-600 mb-1">{{ subclass.name }}</h3>
            {% if subclass.description %}
              <p class="text-sm text-gray-600">{{ subclass.description[:80] }}{% if subclass.description|length > 80 %}...{% endif %}</p>
            {% endif %}
          </a>
        {% endfor %}
      </div>
    </div>
  {% endif %}
</div>

<style>
  .prose {
    color: inherit;
  }
  
  .prose p {
    margin: 1rem 0;
    line-height: 1.6;
  }
  
  details summary::-webkit-details-marker {
    display: none;
  }
</style>
{% endblock %}
