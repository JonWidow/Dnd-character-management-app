#!/usr/bin/env python3
"""
Populate class_spell_slots table with D&D 5e spell slot progressions for all classes.
This ensures characters have the correct spell slots when created or leveled up.
"""

import sys
import os

# Add parent directory to path so we can import app
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from app import app, db
from app.models import CharacterClassModel
from app.models.spell_slots import ClassSpellSlots

# D&D 5e Spell Slot Progressions by Class
# Source: D&D 5e Player's Handbook
SPELL_PROGRESSIONS = {
    "Bard": [
        (1, 0, 0, 0, 0, 0, 0, 0, 0),
        (2, 2, 0, 0, 0, 0, 0, 0, 0),
        (3, 3, 0, 0, 0, 0, 0, 0, 0),
        (4, 3, 2, 0, 0, 0, 0, 0, 0),
        (5, 4, 3, 0, 0, 0, 0, 0, 0),
        (6, 4, 3, 0, 0, 0, 0, 0, 0),
        (7, 4, 3, 2, 0, 0, 0, 0, 0),
        (8, 4, 3, 3, 0, 0, 0, 0, 0),
        (9, 4, 3, 3, 1, 0, 0, 0, 0),
        (10, 4, 3, 3, 2, 0, 0, 0, 0),
        (11, 4, 3, 3, 2, 1, 0, 0, 0),
        (12, 4, 3, 3, 2, 1, 0, 0, 0),
        (13, 4, 3, 3, 2, 1, 1, 0, 0),
        (14, 4, 3, 3, 2, 1, 1, 0, 0),
        (15, 4, 3, 3, 2, 2, 1, 1, 0),
        (16, 4, 3, 3, 2, 2, 1, 1, 0),
        (17, 4, 3, 3, 2, 2, 1, 1, 1),
        (18, 4, 3, 3, 3, 2, 1, 1, 1),
        (19, 4, 3, 3, 3, 2, 2, 1, 1),
        (20, 4, 3, 3, 3, 2, 2, 2, 1),
    ],
    "Cleric": [
        (1, 0, 0, 0, 0, 0, 0, 0, 0),
        (2, 2, 0, 0, 0, 0, 0, 0, 0),
        (3, 3, 0, 0, 0, 0, 0, 0, 0),
        (4, 3, 2, 0, 0, 0, 0, 0, 0),
        (5, 4, 3, 0, 0, 0, 0, 0, 0),
        (6, 4, 3, 0, 0, 0, 0, 0, 0),
        (7, 4, 3, 2, 0, 0, 0, 0, 0),
        (8, 4, 3, 3, 0, 0, 0, 0, 0),
        (9, 4, 3, 3, 1, 0, 0, 0, 0),
        (10, 4, 3, 3, 2, 0, 0, 0, 0),
        (11, 5, 3, 3, 2, 1, 0, 0, 0),
        (12, 5, 3, 3, 2, 1, 0, 0, 0),
        (13, 5, 3, 3, 2, 1, 1, 0, 0),
        (14, 5, 3, 3, 2, 1, 1, 0, 0),
        (15, 5, 3, 3, 2, 2, 1, 1, 0),
        (16, 5, 3, 3, 2, 2, 1, 1, 0),
        (17, 5, 3, 3, 2, 2, 1, 1, 1),
        (18, 5, 3, 3, 3, 2, 1, 1, 1),
        (19, 5, 3, 3, 3, 2, 2, 1, 1),
        (20, 5, 3, 3, 3, 2, 2, 2, 1),
    ],
    "Druid": [
        (1, 0, 0, 0, 0, 0, 0, 0, 0),
        (2, 2, 0, 0, 0, 0, 0, 0, 0),
        (3, 3, 0, 0, 0, 0, 0, 0, 0),
        (4, 3, 2, 0, 0, 0, 0, 0, 0),
        (5, 4, 3, 0, 0, 0, 0, 0, 0),
        (6, 4, 3, 0, 0, 0, 0, 0, 0),
        (7, 4, 3, 2, 0, 0, 0, 0, 0),
        (8, 4, 3, 3, 0, 0, 0, 0, 0),
        (9, 4, 3, 3, 1, 0, 0, 0, 0),
        (10, 4, 3, 3, 2, 0, 0, 0, 0),
        (11, 5, 3, 3, 2, 1, 0, 0, 0),
        (12, 5, 3, 3, 2, 1, 0, 0, 0),
        (13, 5, 3, 3, 2, 1, 1, 0, 0),
        (14, 5, 3, 3, 2, 1, 1, 0, 0),
        (15, 5, 3, 3, 2, 2, 1, 1, 0),
        (16, 5, 3, 3, 2, 2, 1, 1, 0),
        (17, 5, 3, 3, 2, 2, 1, 1, 1),
        (18, 5, 3, 3, 3, 2, 1, 1, 1),
        (19, 5, 3, 3, 3, 2, 2, 1, 1),
        (20, 5, 3, 3, 3, 2, 2, 2, 1),
    ],
    "Paladin": [
        (1, 0, 0, 0, 0, 0, 0, 0, 0),
        (2, 0, 0, 0, 0, 0, 0, 0, 0),
        (3, 0, 0, 0, 0, 0, 0, 0, 0),
        (4, 2, 0, 0, 0, 0, 0, 0, 0),
        (5, 2, 0, 0, 0, 0, 0, 0, 0),
        (6, 2, 0, 0, 0, 0, 0, 0, 0),
        (7, 3, 0, 0, 0, 0, 0, 0, 0),
        (8, 3, 0, 0, 0, 0, 0, 0, 0),
        (9, 3, 2, 0, 0, 0, 0, 0, 0),
        (10, 3, 2, 0, 0, 0, 0, 0, 0),
        (11, 3, 3, 0, 0, 0, 0, 0, 0),
        (12, 3, 3, 0, 0, 0, 0, 0, 0),
        (13, 3, 3, 1, 0, 0, 0, 0, 0),
        (14, 3, 3, 1, 0, 0, 0, 0, 0),
        (15, 3, 3, 2, 0, 0, 0, 0, 0),
        (16, 3, 3, 2, 0, 0, 0, 0, 0),
        (17, 3, 3, 3, 1, 0, 0, 0, 0),
        (18, 3, 3, 3, 1, 0, 0, 0, 0),
        (19, 3, 3, 3, 2, 0, 0, 0, 0),
        (20, 3, 3, 3, 2, 0, 0, 0, 0),
    ],
    "Ranger": [
        (1, 0, 0, 0, 0, 0, 0, 0, 0),
        (2, 0, 0, 0, 0, 0, 0, 0, 0),
        (3, 0, 0, 0, 0, 0, 0, 0, 0),
        (4, 2, 0, 0, 0, 0, 0, 0, 0),
        (5, 2, 0, 0, 0, 0, 0, 0, 0),
        (6, 2, 0, 0, 0, 0, 0, 0, 0),
        (7, 3, 0, 0, 0, 0, 0, 0, 0),
        (8, 3, 0, 0, 0, 0, 0, 0, 0),
        (9, 3, 2, 0, 0, 0, 0, 0, 0),
        (10, 3, 2, 0, 0, 0, 0, 0, 0),
        (11, 3, 3, 0, 0, 0, 0, 0, 0),
        (12, 3, 3, 0, 0, 0, 0, 0, 0),
        (13, 3, 3, 1, 0, 0, 0, 0, 0),
        (14, 3, 3, 1, 0, 0, 0, 0, 0),
        (15, 3, 3, 2, 0, 0, 0, 0, 0),
        (16, 3, 3, 2, 0, 0, 0, 0, 0),
        (17, 3, 3, 3, 1, 0, 0, 0, 0),
        (18, 3, 3, 3, 1, 0, 0, 0, 0),
        (19, 3, 3, 3, 2, 0, 0, 0, 0),
        (20, 3, 3, 3, 2, 0, 0, 0, 0),
    ],
    "Sorcerer": [
        (1, 2, 0, 0, 0, 0, 0, 0, 0),
        (2, 3, 0, 0, 0, 0, 0, 0, 0),
        (3, 4, 2, 0, 0, 0, 0, 0, 0),
        (4, 4, 3, 0, 0, 0, 0, 0, 0),
        (5, 4, 3, 2, 0, 0, 0, 0, 0),
        (6, 4, 3, 3, 0, 0, 0, 0, 0),
        (7, 4, 3, 3, 1, 0, 0, 0, 0),
        (8, 4, 3, 3, 2, 0, 0, 0, 0),
        (9, 4, 3, 3, 3, 1, 0, 0, 0),
        (10, 4, 3, 3, 3, 2, 0, 0, 0),
        (11, 4, 3, 3, 3, 2, 1, 0, 0),
        (12, 4, 3, 3, 3, 2, 1, 0, 0),
        (13, 4, 3, 3, 3, 2, 1, 1, 0),
        (14, 4, 3, 3, 3, 2, 1, 1, 0),
        (15, 4, 3, 3, 3, 2, 2, 1, 1),
        (16, 4, 3, 3, 3, 2, 2, 1, 1),
        (17, 4, 3, 3, 3, 2, 2, 1, 1),
        (18, 4, 3, 3, 3, 3, 2, 1, 1),
        (19, 4, 3, 3, 3, 3, 2, 2, 1),
        (20, 4, 3, 3, 3, 3, 2, 2, 1),
    ],
    "Warlock": [
        (1, 1, 0, 0, 0, 0, 0, 0, 0),
        (2, 2, 0, 0, 0, 0, 0, 0, 0),
        (3, 2, 2, 0, 0, 0, 0, 0, 0),
        (4, 3, 2, 0, 0, 0, 0, 0, 0),
        (5, 3, 2, 2, 0, 0, 0, 0, 0),
        (6, 3, 3, 2, 0, 0, 0, 0, 0),
        (7, 3, 3, 2, 2, 0, 0, 0, 0),
        (8, 3, 3, 3, 2, 0, 0, 0, 0),
        (9, 3, 3, 3, 2, 2, 0, 0, 0),
        (10, 3, 3, 3, 3, 2, 0, 0, 0),
        (11, 3, 3, 3, 3, 2, 1, 0, 0),
        (12, 3, 3, 3, 3, 2, 1, 0, 0),
        (13, 3, 3, 3, 3, 2, 1, 1, 0),
        (14, 3, 3, 3, 3, 2, 1, 1, 0),
        (15, 3, 3, 3, 3, 2, 1, 1, 1),
        (16, 3, 3, 3, 3, 2, 1, 1, 1),
        (17, 4, 3, 3, 3, 2, 1, 1, 1),
        (18, 4, 3, 3, 3, 3, 1, 1, 1),
        (19, 4, 3, 3, 3, 3, 2, 1, 1),
        (20, 4, 3, 3, 3, 3, 2, 2, 1),
    ],
    "Wizard": [
        (1, 2, 0, 0, 0, 0, 0, 0, 0),
        (2, 3, 0, 0, 0, 0, 0, 0, 0),
        (3, 4, 2, 0, 0, 0, 0, 0, 0),
        (4, 4, 3, 0, 0, 0, 0, 0, 0),
        (5, 4, 3, 2, 0, 0, 0, 0, 0),
        (6, 4, 3, 3, 0, 0, 0, 0, 0),
        (7, 4, 3, 3, 1, 0, 0, 0, 0),
        (8, 4, 3, 3, 2, 0, 0, 0, 0),
        (9, 4, 3, 3, 3, 1, 0, 0, 0),
        (10, 4, 3, 3, 3, 2, 0, 0, 0),
        (11, 4, 3, 3, 3, 2, 1, 0, 0),
        (12, 4, 3, 3, 3, 2, 1, 0, 0),
        (13, 4, 3, 3, 3, 2, 1, 1, 0),
        (14, 4, 3, 3, 3, 2, 1, 1, 0),
        (15, 4, 3, 3, 3, 2, 2, 1, 1),
        (16, 4, 3, 3, 3, 2, 2, 1, 1),
        (17, 4, 3, 3, 3, 2, 2, 2, 1),
        (18, 4, 3, 3, 3, 3, 2, 2, 1),
        (19, 4, 3, 3, 3, 3, 2, 2, 2),
        (20, 4, 3, 3, 3, 3, 2, 2, 2),
    ],
    # Non-spellcasting classes: all zeros
    "Barbarian": [(level, 0, 0, 0, 0, 0, 0, 0, 0, 0) for level in range(1, 21)],
    "Fighter": [(level, 0, 0, 0, 0, 0, 0, 0, 0, 0) for level in range(1, 21)],
    "Monk": [(level, 0, 0, 0, 0, 0, 0, 0, 0, 0) for level in range(1, 21)],
    "Rogue": [(level, 0, 0, 0, 0, 0, 0, 0, 0, 0) for level in range(1, 21)],
}

def populate_spell_slots():
    """Populate class_spell_slots table with D&D 5e progressions."""
    with app.app_context():
        # Clear existing data
        ClassSpellSlots.query.delete()
        db.session.commit()
        print("Cleared existing spell slots.")
        
        count = 0
        for class_name, progression in SPELL_PROGRESSIONS.items():
            # Get the class
            char_class = CharacterClassModel.query.filter_by(name=class_name).first()
            if not char_class:
                print(f"Warning: Class '{class_name}' not found, skipping.")
                continue
            
            # Add entries for each level
            for level_data in progression:
                level = level_data[0]
                slots = level_data[1:]  # slots 1-8 (9 spell levels, but slot 9 is always 0)
                
                slot_entry = ClassSpellSlots(
                    class_id=char_class.id,
                    class_level=level,
                    slot_1=slots[0] if len(slots) > 0 else 0,
                    slot_2=slots[1] if len(slots) > 1 else 0,
                    slot_3=slots[2] if len(slots) > 2 else 0,
                    slot_4=slots[3] if len(slots) > 3 else 0,
                    slot_5=slots[4] if len(slots) > 4 else 0,
                    slot_6=slots[5] if len(slots) > 5 else 0,
                    slot_7=slots[6] if len(slots) > 6 else 0,
                    slot_8=slots[7] if len(slots) > 7 else 0,
                    slot_9=0,  # Slot level 9 doesn't exist in 5e
                )
                db.session.add(slot_entry)
                count += 1
        
        db.session.commit()
        print(f"Successfully populated {count} spell slot entries.")

if __name__ == '__main__':
    populate_spell_slots()
